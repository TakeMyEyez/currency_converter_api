{% extends "base.html" %}

{% block content %}
<div class="container mt-4">
	<div class="d-flex justify-content-between align-items-center mb-4">
		<h1 class="text-primary"><i class="fas fa-exchange-alt me-2"></i>Управление курсами валют</h1>
		<a href="/admin" class="btn btn-outline-primary">
			<i class="fas fa-arrow-left me-1"></i>Назад в админку
		</a>
	</div>

	<div class="card shadow mb-4">
		<div class="card-header bg-primary text-white">
			<h5 class="mb-0"><i class="fas fa-plus-circle me-2"></i>Добавить новый курс</h5>
		</div>
		<div class="card-body">
			<form method="POST" action="/admin/api/rates" class="row g-3">
				<div class="col-md-3">
					<label for="base_currency" class="form-label">Базовая валюта</label>
					<input type="text" class="form-control" id="base_currency" name="base_currency" placeholder="USD"
						maxlength="3" required pattern="[A-Z]{3}">
				</div>
				<div class="col-md-3">
					<label for="target_currency" class="form-label">Целевая валюта</label>
					<input type="text" class="form-control" id="target_currency" name="target_currency" placeholder="EUR"
						maxlength="3" required pattern="[A-Z]{3}">
				</div>
				<div class="col-md-3">
					<label for="rate" class="form-label">Курс</label>
					<input type="number" class="form-control" id="rate" name="rate" step="0.0001" placeholder="0.92" required
						min="0.0001">
				</div>
				<div class="col-md-3 d-flex align-items-end">
					<button type="submit" class="btn btn-primary w-100">
						<i class="fas fa-save me-1"></i>Добавить курс
					</button>
				</div>
			</form>
		</div>
	</div>

	<div class="card shadow">
		<div class="card-header bg-primary text-white d-flex justify-content-between align-items-center">
			<h5 class="mb-0"><i class="fas fa-list me-2"></i>Список курсов валют</h5>
			<span class="badge bg-light text-dark fs-6">{{ rates|length }} записей</span>
		</div>
		<div class="card-body">
			{% if rates %}
			<div class="table-responsive">
				<table class="table table-hover table-bordered">
					<thead class="table-light">
						<tr>
							<th>ID</th>
							<th>Базовая</th>
							<th>Целевая</th>
							<th>Курс</th>
							<th>Активен</th>
							<th>Обновлено</th>
							<th>Действия</th>
						</tr>
					</thead>
					<tbody>
						{% for rate in rates %}
						<tr>
							<td><span class="badge bg-secondary">{{ rate.id }}</span></td>
							<td class="fw-bold">{{ rate.base_currency }}</td>
							<td class="fw-bold">{{ rate.target_currency }}</td>
							<td>{{ "%.4f"|format(rate.rate) }}</td>
							<td>
								{% if rate.is_active %}
								<span class="badge bg-success">Активен</span>
								{% else %}
								<span class="badge bg-danger">Неактивен</span>
								{% endif %}
							</td>
							<td>{{ rate.last_updated.strftime('%d.%m.%Y %H:%M') }}</td>
							<td>
								<div class="d-flex gap-2">
									<form method="POST" action="/admin/api/rates/{{ rate.id }}/toggle" style="display:inline;">
										<button type="submit"
											class="btn btn-sm btn-{% if rate.is_active %}danger{% else %}success{% endif %}"
											title="{% if rate.is_active %}Деактивировать{% else %}Активировать{% endif %}">
											<i class="fas fa-{% if rate.is_active %}times{% else %}check{% endif %}"></i>
										</button>
									</form>
									<button class="btn btn-sm btn-warning" data-bs-toggle="modal" data-bs-target="#editModal"
										data-id="{{ rate.id }}" data-base="{{ rate.base_currency }}"
										data-target="{{ rate.target_currency }}" data-rate="{{ rate.rate }}"
										data-active="{{ rate.is_active }}" title="Редактировать">
										<i class="fas fa-edit"></i>
									</button>
									<form method="POST" action="/admin/api/rates/{{ rate.id }}/delete"
										onsubmit="return confirm('Вы уверены, что хотите удалить этот курс? {{ rate.base_currency }} → {{ rate.target_currency }}?')">
										<button type="submit" class="btn btn-sm btn-danger" title="Удалить">
											<i class="fas fa-trash"></i>
										</button>
									</form>
								</div>
							</td>
						</tr>
						{% endfor %}
					</tbody>
				</table>
			</div>
			{% else %}
			<div class="alert alert-info text-center py-4">
				<i class="fas fa-info-circle fa-2x mb-2"></i>
				<p class="h5">Нет сохраненных курсов валют</p>
				<p class="text-muted">Добавьте первый курс с помощью формы выше</p>
			</div>
			{% endif %}
		</div>
	</div>
</div>

<div class="modal fade" id="editModal" tabindex="-1" aria-hidden="true">
	<div class="modal-dialog">
		<div class="modal-content">
			<div class="modal-header bg-warning">
				<h5 class="modal-title"><i class="fas fa-edit me-2"></i>Редактировать курс</h5>
				<button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
			</div>
			<form id="editForm" method="POST">
				<div class="modal-body">
					<input type="hidden" id="edit_id" name="id">
					<div class="mb-3">
						<label class="form-label">Базовая валюта</label>
						<input type="text" class="form-control" id="edit_base" name="base_currency" readonly>
					</div>
					<div class="mb-3">
						<label class="form-label">Целевая валюта</label>
						<input type="text" class="form-control" id="edit_target" name="target_currency" readonly>
					</div>
					<div class="mb-3">
						<label for="edit_rate" class="form-label">Новый курс</label>
						<input type="number" class="form-control" id="edit_rate" name="rate" step="0.0001" required>
					</div>
					<div class="form-check">
						<input class="form-check-input" type="checkbox" id="edit_active" name="is_active">
						<label class="form-check-label" for="edit_active">
							Активировать курс
						</label>
					</div>
				</div>
				<div class="modal-footer">
					<button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Отмена</button>
					<button type="submit" class="btn btn-warning">Сохранить изменения</button>
				</div>
			</form>
		</div>
	</div>
</div>

<script>
	document.addEventListener('DOMContentLoaded', function () {
		var editModal = document.getElementById('editModal')
		editModal.addEventListener('show.bs.modal', function (event) {
			var button = event.relatedTarget
			var id = button.getAttribute('data-id')
			var base = button.getAttribute('data-base')
			var target = button.getAttribute('data-target')
			var rate = button.getAttribute('data-rate')
			var active = button.getAttribute('data-active') === 'True'

			document.getElementById('edit_id').value = id
			document.getElementById('edit_base').value = base
			document.getElementById('edit_target').value = target
			document.getElementById('edit_rate').value = rate
			document.getElementById('edit_active').checked = active

			document.getElementById('editForm').action = '/admin/api/rates/' + id + '/update'
		})

		const urlParams = new URLSearchParams(window.location.search)
		if (urlParams.has('error')) {
			alert('Ошибка: ' + decodeURIComponent(urlParams.get('error')))
		}
		if (urlParams.has('success')) {
			alert('Успешно: ' + decodeURIComponent(urlParams.get('success')))
		}
	});
</script>
{% endblock %}