{% extends "base.html" %}

{% block content %}
<div class="row">
	<div class="col-12">
		<div class="card shadow">
			<div class="card-header bg-info text-white d-flex justify-content-between align-items-center">
				<h4><i class="fas fa-history"></i> История конвертаций</h4>
				<div>
					<span class="badge bg-light text-dark">{{ conversions|length }} операций</span>
					<a href="/convert" class="btn btn-light btn-sm ms-2">
						<i class="fas fa-plus"></i> Новая конвертация
					</a>
				</div>
			</div>
			<div class="card-body">
				{% if conversions %}
				<div class="table-responsive">
					<table class="table table-hover">
						<thead class="table-light">
							<tr>
								<th>Дата и время</th>
								<th>Сумма</th>
								<th>Из валюты</th>
								<th>В валюту</th>
								<th>Результат</th>
								<th>Курс</th>
								<th>Действия</th>
							</tr>
						</thead>
						<tbody>
							{% for conv in conversions %}
							<tr>
								<td>
									<div class="small text-muted">{{ conv.timestamp.strftime('%d.%m.%Y') }}</div>
									<div class="fw-bold">{{ conv.timestamp.strftime('%H:%M:%S') }}</div>
								</td>
								<td>
									<span class="badge bg-primary fs-6">{{ conv.amount }}</span>
								</td>
								<td>
									<span class="badge bg-secondary">{{ conv.from_currency }}</span>
								</td>
								<td>
									<span class="badge bg-success">{{ conv.to_currency }}</span>
								</td>
								<td>
									<span class="badge bg-success fs-6">{{ conv.converted_amount }}</span>
								</td>
								<td>
									<span class="text-muted">{{ conv.rate_used|round(6) }}</span>
								</td>
								<td>
									<a href="/convert?amount={{ conv.amount }}&from_currency={{ conv.from_currency }}&to_currency={{ conv.to_currency }}"
										class="btn btn-sm btn-outline-primary" title="Повторить">
										<i class="fas fa-redo"></i>
									</a>
								</td>
							</tr>
							{% endfor %}
						</tbody>
					</table>
				</div>

				<div class="row mt-4">
					<div class="col-md-4">
						<div class="card">
							<div class="card-body text-center">
								<h6>Всего операций</h6>
								<h3>{{ conversions|length }}</h3>
							</div>
						</div>
					</div>
					<div class="col-md-4">
						<div class="card">
							<div class="card-body text-center">
								<h6>Общая сумма</h6>
								<h3>
									{% set total = conversions|map(attribute='amount')|sum %}
									{{ total|round(2) }}
								</h3>
							</div>
						</div>
					</div>
					<div class="col-md-4">
						<div class="card">
							<div class="card-body text-center">
								<h6>Средний курс</h6>
								<h3>
									{% set avg_rate = conversions|map(attribute='rate_used')|sum / conversions|length if
									conversions|length > 0 else 0 %}
									{{ avg_rate|round(4) }}
								</h3>
							</div>
						</div>
					</div>
				</div>
				{% else %}
				<div class="text-center py-5">
					<i class="fas fa-history fa-4x text-muted mb-3"></i>
					<h4>История операций пуста</h4>
					<p class="text-muted mb-4">Здесь будут отображаться все ваши конвертации</p>
					<a href="/convert" class="btn btn-primary btn-lg">
						<i class="fas fa-calculator"></i> Сделать первую конвертацию
					</a>
				</div>
				{% endif %}
			</div>
		</div>
	</div>
</div>
{% endblock %}